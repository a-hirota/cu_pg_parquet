# Parquet圧縮方式ベンチマーク結果

## 概要

GPUPGParserでは、PostgreSQLのバイナリデータをGPUで処理してParquetファイルに変換する際、
様々な圧縮方式を選択できます。この文書では、各圧縮方式の性能比較結果を報告します。

## 実験環境

- **テーブル**: lineorder（SSB benchmark）
- **データサイズ**: 52.86 GB
- **行数**: 246,012,324 行
- **並列度**: 16接続
- **チャンク数**: 16
- **GPU**: NVIDIA GPU with cuDF support

## 実験結果

### 相対性能比較（Snappy基準）

| 圧縮方式 | 処理時間差 | ファイルサイズ差 | 時間比率 | サイズ比率 |
|---------|-----------|----------------|----------|-----------|
| **snappy** | 基準 | 基準 | 1.00x | 1.00x |
| **lz4** | +0.99秒 | -841MB | 1.02x | 0.91x |
| **zstd** ⭐ | **-0.51秒** | **-4254MB** | **0.99x** | **0.56x** |
| **gzip** ⚠️ | +974.18秒 | -2778MB | 18.81x | 0.71x |
| **none** | +14.02秒 | +17389MB | 1.26x | 2.79x |

### 詳細結果

| 圧縮方式 | 処理時間 | ファイルサイズ | 圧縮率 | スループット |
|---------|---------|--------------|--------|-------------|
| **snappy** | 73.47秒 | 9,692.61 MB | 5.58x | 0.99 GB/秒 |
| **lz4** | 74.04秒 | 8,852.08 MB | 6.11x | 0.98 GB/秒 |
| **zstd** ⭐ | 72.07秒 | 5,438.41 MB | 9.95x | 1.00 GB/秒 |
| **gzip** ⚠️ | 1047.65秒 | 6,914.25 MB | 7.88x | 0.07 GB/秒 |
| **none** | 87.49秒 | 27,081.61 MB | 2.00x | 0.82 GB/秒 |

## 分析と推奨事項

### 1. **zstd（推奨）** ⭐

- **最速の処理時間**: Snappyより0.51秒速い
- **最高の圧縮率**: 9.95x（ファイルサイズが56%に削減）
- **優れたバランス**: 速度と圧縮率の両方で優秀
- **GPUネイティブサポート**: cuDFで完全にGPU上で処理

### 2. **snappy**

- **安定した性能**: 標準的な選択肢
- **適度な圧縮率**: 5.58x
- **広い互換性**: 多くのツールでサポート

### 3. **lz4**

- **Snappyと同等の速度**: わずか0.99秒の差
- **やや良い圧縮率**: 6.11x（Snappyより9%改善）
- **高速な展開**: 読み取り時のパフォーマンスが優秀

### 4. **gzip（非推奨）** ⚠️

- **極めて遅い**: Snappyの18.81倍の時間
- **CPUフォールバック**: cuDFがGPUネイティブサポートしていない
- **使用を避けるべき**: GPU→CPU転送のオーバーヘッドが大きい

### 5. **none（圧縮なし）**

- **最大のファイルサイズ**: 27GB（元データの51%）
- **処理時間の増加**: I/Oボトルネックによる
- **特殊用途のみ**: 後処理で独自の圧縮を適用する場合

## デフォルト設定の変更

実験結果に基づき、デフォルトの圧縮方式を`snappy`から`zstd`に変更しました：

```bash
# 新しいデフォルト（zstd）で実行
python cu_pg_parquet.py --table lineorder

# 従来のsnappyを使用する場合
python cu_pg_parquet.py --table lineorder --compression snappy
```

## 技術的な注意事項

### cuDFのGPU圧縮サポート

cuDFのParquetライターは以下の圧縮方式をGPU上でネイティブサポートしています：

- ✅ **snappy**
- ✅ **lz4**
- ✅ **zstd**
- ✅ **brotli**（実験では未テスト）
- ❌ **gzip**（CPUフォールバック）

gzipを使用すると、cuDFは自動的にPyArrow経由のCPU処理にフォールバックするため、
GPU→CPU→Disk の転送が発生し、大幅な性能低下を引き起こします。

### メモリ使用量

圧縮方式により一時的なメモリ使用量が異なります：

- **zstd**: 圧縮辞書のため追加メモリが必要
- **none**: 圧縮バッファが不要なため最小メモリ使用

## まとめ

**zstd**は、処理速度と圧縮率の両方で最高のパフォーマンスを示し、
GPUネイティブサポートも完全であるため、新しいデフォルトとして採用しました。

特別な要件がない限り、zstdの使用を推奨します。
